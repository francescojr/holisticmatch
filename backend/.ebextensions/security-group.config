commands:
  01_get_sg_id:
    command: |
      INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
      SG_ID=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID --region us-east-2 --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' --output text)
      echo $SG_ID > /tmp/sg_id.txt
    ignoreErrors: true
  02_allow_outbound:
    command: |
      SG_ID=$(cat /tmp/sg_id.txt)
      aws ec2 authorize-security-group-egress --group-id $SG_ID --protocol tcp --port 5432 --cidr 0.0.0.0/0 --region us-east-2 || true
      aws ec2 authorize-security-group-egress --group-id $SG_ID --protocol tcp --port 443 --cidr 0.0.0.0/0 --region us-east-2 || true
      aws ec2 authorize-security-group-egress --group-id $SG_ID --protocol tcp --port 80 --cidr 0.0.0.0/0 --region us-east-2 || true
    ignoreErrors: true
